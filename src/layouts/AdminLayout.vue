<template>
  <AppShell
    :nav-items="navItems"
    :profile="shellProfile"
    :locale-options="localeOptions"
    :current-locale="currentLocale"
    @change-locale="onLocaleChange"
    @logout="onLogout"
  >
    <template #logo>
      <BrandLogo :show-strapline="false" />
    </template>

    <template #sidebar-footer>
      <h3 class="font-semibold text-ink">{{ t('control.brand.infoTitle') }}</h3>
      <p class="mt-2 text-sm leading-relaxed text-slate-600">
        {{ t('control.brand.infoDescription') }}
      </p>
    </template>

    <template #header>
      <p class="text-xs font-medium uppercase tracking-wide text-slate-400">{{ t('control.header.greeting') }}</p>
      <div class="mt-2 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-ink">{{ profile.fullName }}</h1>
          <p class="text-xs text-slate-500">{{ profileSubtitle }}</p>
        </div>
        <p class="text-xs text-slate-400 sm:text-right">
          {{ t('control.header.lastUpdated') }}: {{ lastUpdated }}
        </p>
      </div>
    </template>

    <slot />
  </AppShell>
</template>

<script setup>
import { computed } from 'vue';
import { storeToRefs } from 'pinia';
import { useRoute, useRouter } from 'vue-router';
import { useI18n } from 'vue-i18n';
import { Shield } from 'lucide-vue-next';
import { useAuth } from '@/shared/composables/useAuth';
import { useNotifications } from '@/shared/composables/useNotifications';
import { useI18nStore } from '@/shared/stores/i18n';
import BrandLogo from '@/shared/components/common/BrandLogo.vue';
import AppShell from '@/shared/components/layout/AppShell.vue';

const { user, lastFetchedAt, logout } = useAuth();
const route = useRoute();
const router = useRouter();
const { t, locale } = useI18n({ useScope: 'global' });
const { notifySuccess, notifyError } = useNotifications();
const i18nStore = useI18nStore();
const { locales: availableLocalesRef, locale: activeLocale } = storeToRefs(i18nStore);

const profile = computed(() => ({
  fullName: user.value?.fullName ?? t('app.header.guestName'),
  avatar:
    user.value?.avatar ??
    `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent('Admin')}&backgroundColor=ef4444`
}));

const profileSubtitle = computed(() => t('control.header.subtitle'));

const shellProfile = computed(() => ({
  fullName: profile.value.fullName,
  subtitle: profileSubtitle.value,
  avatar: profile.value.avatar
}));

const lastUpdated = computed(() => {
  if (!lastFetchedAt?.value) return t('app.header.noSync');
  try {
    return new Intl.DateTimeFormat(locale.value === 'ru' ? 'ru-RU' : 'uz-UZ', {
      hour: '2-digit',
      minute: '2-digit'
    }).format(new Date(lastFetchedAt.value));
  } catch (error) {
    console.error('Error formatting lastUpdated:', error);
    return t('app.header.noSync');
  }
});

const navItems = computed(() => {
  const name = route.name || '';
  return [
    {
      id: 'admin-dashboard',
      label: 'Dashboard',
      to: { name: 'admin.dashboard' },
      iconComponent: Shield,
      active: name === 'admin.dashboard'
    },
    {
      id: 'admin-users',
      label: 'Foydalanuvchilar',
      to: { name: 'admin.users' },
      iconComponent: Shield,
      active: name === 'admin.users'
    },
    {
      id: 'admin-directions',
      label: 'Yo\'nalishlar',
      to: { name: 'admin.directions' },
      iconComponent: Shield,
      active: name === 'admin.directions'
    },
    {
      id: 'admin-olympiads',
      label: 'Olimpiadalar',
      to: { name: 'admin.olympiads' },
      iconComponent: Shield,
      active: name === 'admin.olympiads'
    },
    {
      id: 'admin-payments',
      label: 'To\'lovlar',
      to: { name: 'admin.payments' },
      iconComponent: Shield,
      active: name === 'admin.payments'
    },
    {
      id: 'admin-plans',
      label: 'Obuna rejalari',
      to: { name: 'admin.plans' },
      iconComponent: Shield,
      active: name === 'admin.plans'
    },
    {
      id: 'admin-analytics',
      label: 'Analitika',
      to: { name: 'admin.analytics' },
      iconComponent: Shield,
      active: name === 'admin.analytics'
    }
  ];
});

const localeOptions = computed(() => availableLocalesRef.value);
const currentLocale = computed(() => activeLocale.value);

async function onLogout() {
  await logout();
  notifySuccess('logout');
  router.push({ name: 'login' });
}

function onLocaleChange(value) {
  if (value === currentLocale.value) {
    return;
  }

  const success = i18nStore.setLocale(value);
  if (!success) {
    notifyError('generic');
    return;
  }

  locale.value = value;

  const selected = localeOptions.value.find((option) => option.code === value);
  notifySuccess('localeChange', {
    language: selected?.label ?? value.toUpperCase()
  });
}
</script>
